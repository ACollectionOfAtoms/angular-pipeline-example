#!/bin/bash -e

if [[ -z ${ROLLBAR_ACCESS_TOKEN+x} ]]; then
  echo 'ROLLBAR_ACCESS_TOKEN is not set'
  exit 1
fi

if [[ -z ${GIT_COMMIT_SHA+x} ]]; then
  echo 'GIT_COMMIT_SHA is not set'
  exit 1
fi

if [[ -z ${GIT_COMMIT_AUTHOR+x} ]]; then
  echo 'GIT_COMMIT_AUTHOR is not set'
  exit 1
fi

if [[ -z ${DEPLOY_STATUS+x} ]]; then
  echo 'DEPLOY_STATUS is not set'
  exit 1
fi

curl -f https://api.rollbar.com/api/1/deploy/ \
  -F access_token=${ROLLBAR_ACCESS_TOKEN} \
  -F status=${DEPLOY_STATUS} \
  -F environment=production \
  -F revision=${GIT_COMMIT_SHA} \
  -F local_username=${GIT_COMMIT_AUTHOR}

echo
echo "Rollbar notified of deploy: revision=${GIT_COMMIT_SHA} status=${DEPLOY_STATUS}"
