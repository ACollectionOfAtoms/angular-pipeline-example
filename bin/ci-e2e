#!/bin/bash

if [[ -z ${GIT_COMMIT_SHA+x} ]]; then
  echo 'GIT_COMMIT_SHA is not set'
  exit 1
fi

if [[ -z ${GIT_BRANCH+x} ]]; then
  echo 'GIT_BRANCH is not set'
  exit 1
fi

if [[ -z ${TEST_IMAGE+x} ]]; then
  echo 'TEST_IMAGE is not set'
  exit 1
fi

if [[ -z ${DIST_IMAGE+x} ]]; then
  echo 'DIST_IMAGE is not set'
  exit 1
fi

if [[ "${CI}" == "true" ]]; then
  if [[ -z ${MASTER_BUILD_S3_KEY_PREFIX+x} ]]; then
    echo 'MASTER_BUILD_S3_KEY_PREFIX must be set when CI=true'
    exit 1
  fi

  if [[ -z ${BUILD_S3_KEY_PREFIX+x} ]]; then
    echo 'BUILD_S3_KEY_PREFIX must be set when CI=true'
    exit 1
  fi
fi

export SELENIUM_CHROME_IMAGE=node-chrome
export SELENIUM_FIREFOX_IMAGE=node-firefox

CONTAINER_NAME=test-${DOCKER_BUILD_CHECKSUM}
CONTAINER_REPORTS_ROOT_DIR=${CONTAINER_SRC_DIR}/reports
BUILD_REPORTS_S3_KEY_PREFIX=${BUILD_S3_KEY_PREFIX%/}/reports/e2e/
MASTER_REPORTS_S3_KEY_PREFIX=${MASTER_BUILD_S3_KEY_PREFIX%/}/reports/e2e/
MASTER_ALLURE_HISTORY_S3_KEY_PREFIX=${MASTER_REPORTS_S3_KEY_PREFIX%/}/allure/html/history/

is-ci-context() {
  [[ "${CI}" == "true" ]]
}

is-master-branch() {
  [[ "${GIT_BRANCH}" == "master" ]]
}

clean() {
  docker-compose down || :
}

generate-allure-report() {
  export ALLURE_ENVIRONMENT="Hostname=$(hostname)
Git.Commit=${GIT_COMMIT_SHA}
Git.Branch=${GIT_BRANCH}
Docker.Version=$(docker --version)
Docker.TestImage=${TEST_IMAGE}
DockerCompose.Version=$(docker-compose --version)"

  docker-compose run --rm --entrypoint /bin/sh allure -c '
    echo "$ALLURE_ENVIRONMENT" >> e2e/allure/xml/environment.properties &&
    cat e2e/allure/xml/environment.properties &&
    allure generate --clean --report-dir e2e/allure/html e2e/allure/xml'
}

publish-reports() {
  docker-compose run --rm aws \
    s3 cp --quiet --acl private --recursive /work/e2e/ ${BUILD_REPORTS_S3_KEY_PREFIX}

  if [[ "${GIT_BRANCH}" == "master" ]]; then
    docker-compose run --rm aws \
      s3 cp --quiet --acl private --recursive /work/e2e/ ${MASTER_REPORTS_S3_KEY_PREFIX}
  fi
}

do-reports() {
  is-ci-context && is-master-branch \
    && generate-allure-report && publish-reports || :
}

do-tests() {
  docker-compose up \
    --abort-on-container-exit \
    --exit-code-from protractor \
    --force-recreate \
    --remove-orphans \
    --quiet-pull \
    hub firefox chrome webapp protractor
}

do-tests
E2E_EXIT_CODE=$?
do-reports
clean

exit ${E2E_EXIT_CODE}
